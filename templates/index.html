<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>超シンプル版 オンライン聴覚検査</title>

<!-- ★ 外部CSSファイルを読み込む -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>
<body>
<div id="box">
  <h1>オンライン聴覚検査（超シンプル版）</h1>
  <p>1) ヘッドホン装用で音量を調整 → 2) <b>再生</b> → 3) 聞こえた単語を入力 → 4) <b>回答</b></p>

  <p>
    被検者ID：<input id="sid" placeholder="s001" />
    <button id="tone">1 kHzトーン</button>
  </p>

  <p>単語 <span id="idx">0</span>/<span id="total">0</span></p>
  <p>
    <button id="play">▶ 再生</button>
    <button id="repeat">↻ もう一度</button>
  </p>
  <p>
    回答：<input id="ans" placeholder="ひらがな または ローマ字" style="width:60%" />
    <button id="submit">回答</button>
    <button id="skip">スキップ</button>
  </p>
  <p>
    <button id="download">結果をCSV保存</button>
    <button id="reset">最初から</button>
  </p>

  <h3>ログ</h3>
  <div style="max-height:260px;overflow:auto">
    <table>
      <thead><tr><th>#</th><th>語</th><th>正答(規準)</th><th>回答(規準)</th><th>正誤</th><th>再生回数</th></tr></thead>
      <tbody id="log"></tbody>
    </table>
  </div>
</div>

<audio id="audio" preload="auto"></audio>
<script>
  // ===== 1) 単語と音源の一覧（ここだけ自分の音源に合わせて編集） =====
  // 音源は /audio フォルダに置き、ファイル名を合わせてください。
  const ITEMS = [
  {word:"アカガネ", audio:"audio/mya_10101db-0.wav"},
  {word:"ワラバイ", audio:"audio/mya_10102db-0.wav"},
  {word:"ラシャメン", audio:"audio/mya_10103db-0.wav"},
  {word:"ザイカタ", audio:"audio/mya_10104db-0.wav"},
  {word:"カワヨド", audio:"audio/mya_10105db-0.wav"},
  {word:"タカドノ", audio:"audio/mya_10106db-0.wav"},
  {word:"ドカヒン", audio:"audio/mya_10107db-0.wav"},
  {word:"ソマヤマ", audio:"audio/mya_10108db-0.wav"},
  {word:"サトバラ", audio:"audio/mya_10109db-0.wav"},
  {word:"モロハク", audio:"audio/mya_10110db-0.wav"}
  ];

  // ===== 2) ごく簡単な正規化（ひらがな→ローマ字相当／大雑把） =====
  function normalize(t){
  let out = (t || '').trim();

  // 1) カタカナ→ひらがな（Unicode: カタカナに0x60引くとひらがな）
  out = out.replace(/[ァ-ン]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));

  // 2) 英字は小文字に
  out = out.toLowerCase();

  // 3) ひらがな→ローマ字（簡易）
  const hira='あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんがぎぐげござじずぜぞだぢづでどぱぴぷぺぽばびぶべぼゃゅょっー'.split('');
  const roma=['a','i','u','e','o','ka','ki','ku','ke','ko','sa','shi','su','se','so','ta','chi','tsu','te','to','na','ni','nu','ne','no','ha','hi','fu','he','ho','ma','mi','mu','me','mo','ya','yu','yo','ra','ri','ru','re','ro','wa','wo','n','ga','gi','gu','ge','go','za','ji','zu','ze','zo','da','ji','zu','de','do','pa','pi','pu','pe','po','ba','bi','bu','be','bo','ya','yu','yo','tsu','',''];
  for(let i=0;i<hira.length;i++) out = out.replaceAll(hira[i], roma[i] || '');

  // 4) 伸ばし棒は削除（お好みで）
  out = out.replaceAll('ー','');

  return out;
}

  // ===== 3) 状態とUI =====
  const a=document.getElementById('audio');
  const sid=document.getElementById('sid');
  const idxSpan=document.getElementById('idx');
  const totalSpan=document.getElementById('total');
  const ans=document.getElementById('ans');
  const logT=document.getElementById('log');

  let i=0, replay=0, rec=[];
  totalSpan.textContent=ITEMS.length;
  updateUI();

  document.getElementById('play').onclick=()=>play(false);
  document.getElementById('repeat').onclick=()=>play(true);
  document.getElementById('submit').onclick=submit;
  document.getElementById('skip').onclick=()=>{ans.value=''; submit(true)};
  document.getElementById('download').onclick=downloadCSV;
  document.getElementById('reset').onclick=resetAll;
  document.getElementById('tone').onclick=playTone;
  ans.addEventListener('keydown',e=>{ if(e.key==='Enter') submit(); });

  function updateUI(){
    idxSpan.textContent=Math.min(i+1,ITEMS.length);
    ans.focus();
  }

  function play(isRepeat){
    const item=ITEMS[i]; if(!item) return;
    a.src=item.audio; a.play().then(()=>{ if(isRepeat) replay++; else replay=0; }).catch(()=>alert('音源が見つかりません: '+item.audio));
  }

  function playTone(){
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(); const g=ctx.createGain();
    osc.type='sine'; osc.frequency.value=1000; g.gain.value=0.1;
    osc.connect(g).connect(ctx.destination); osc.start(); setTimeout(()=>osc.stop(),500);
  }

  function submit(skipped){
    const item=ITEMS[i]; if(!item) return;
    const goldN=normalize(item.word);
    const ansN=normalize(skipped? '': ans.value);
    const ok=!skipped && ansN && ansN===goldN;
    rec.push({subject:sid.value||'', index:i+1, word:item.word, gold:goldN, resp:ansN, correct:ok?1:0, replay});

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${item.word}</td><td>${goldN}</td><td>${ansN}</td><td>${ok? '◯':'×'}</td><td>${replay}</td>`;
    logT.appendChild(tr);

    i++; replay=0; ans.value='';

    if (i >= ITEMS.length) {
      // 全問題が終わったのでサーバ送信
      sendResultToServer();

      alert('終了しました。CSVを保存できます。');
    }

    updateUI();
  }

  function sendResultToServer() {
    // 正答率を計算
    let correctCount = 0;
    rec.forEach(r => { if (r.correct === 1) correctCount++; });
    const scorePercent = (correctCount / rec.length * 100).toFixed(1) + "%";

    // 送信データをまとめる（Flask側と合わせる）
    const payload = {
      subjectId: sid.value || "",            // 被検者ID
      timestamp: new Date().toISOString(),   // 実施時刻(UTC)
      score: scorePercent,                   // 正答率
      records: rec                           // 全回答ログ
    };

    // 同じサーバ内のAPIに送るので、絶対URLは不要
    fetch("/api/submit", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      // mode: "no-cors" ではないので、レスポンスをちゃんと受け取れる
      if (!res.ok) throw new Error("HTTPエラー " + res.status);
      return res.json();
    })
    .then(data => {
      console.log("送信成功:", data);
    })
    .catch(err => {
      console.error("送信失敗:", err);
      alert("サーバへの送信に失敗しました。ネットワークを確認してください。");
    });
  }


  function downloadCSV(){
    if(rec.length===0){ alert('結果がありません'); return; }
    const header=['subject','index','word','gold','resp','correct','replay'];
    const rows=rec.map(r=>[r.subject,r.index,r.word,r.gold,r.resp,r.correct,r.replay]);
    const csv=[header,...rows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const atag=document.createElement('a');
    atag.href=url; atag.download='result.csv'; atag.click();
    URL.revokeObjectURL(url);
  }

  function resetAll(){ location.reload(); }
</script>
</body>
</html>